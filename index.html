<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- ëª¨ë°”ì¼ ë¹„ìœ¨ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ì •ë¦¬ì •ëˆ ì‹ ê³ ì²´ê³„</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f7;
        }
        header {
            padding: 12px 16px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        h1 {
            font-size: 18px;
            margin: 0 0 8px 0;
        }
        .mode-toggle {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #d0d0d4;
        }
        .mode-btn {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            background: #ffffff;
        }
        .mode-btn.active {
            background: #007aff;
            color: #ffffff;
        }

        main {
            padding: 12px 16px 32px 16px;
            max-width: 960px;
            margin: 0 auto;
        }

        .section-title {
            font-weight: 600;
            margin: 16px 0 6px;
        }

        .floor-picker { margin-top: 4px; }

        .sector-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        .sector-btn {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            background: #e0e0e4;
            cursor: pointer;
            font-size: 13px;
        }
        .sector-btn.selected {
            background: #ff9f0a;
            color: #ffffff;
        }

        .row {
            display: flex;
            gap: 12px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .row > div {
            flex: 1;
            min-width: 180px;
        }

        select {
            width: 100%;
            padding: 6px;
            font-size: 13px;
        }

        .photo-buttons {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .photo-buttons button {
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        .btn-album {
            background: rgba(0,122,255,0.15);
            color: #007aff;
        }
        .btn-camera {
            background: rgba(255,149,0,0.15);
            color: #ff9500;
        }

        .thumb-list {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-top: 6px;
        }
        .thumb-list img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
        }

        .primary-btn {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            font-size: 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: #007aff;
            color: #ffffff;
        }
        .primary-btn:disabled {
            background: #c0c0c8;
            cursor: default;
        }

        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .reports-header h2 {
            font-size: 15px;
            margin: 0;
        }

        .report-card {
            margin-top: 8px;
            background: #ffffff;
            border-radius: 12px;
            padding: 10px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }
        .report-title {
            font-weight: 600;
            font-size: 14px;
        }
        .report-meta {
            font-size: 12px;
            color: #666;
        }
        .report-delete {
            position: absolute;
            right: 8px;
            top: 8px;
            border: none;
            background: #ff3b30;
            color: #ffffff;
            border-radius: 999px;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 15px;
        }

        .report-photos {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            overflow-x: auto;
        }
        .report-photos img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }

        /* íˆíŠ¸ë§µ ê¸°ë³¸ ê·¸ë¦¬ë“œ (B1ìš©) */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .heat-cell {
            border-radius: 8px;
            padding: 10px;
            color: #ffffff;
            font-size: 13px;
            text-align: center;
        }

        /* í‰ë©´ë„ ìœ„ íˆíŠ¸ë§µ / ì„ íƒ */
        .floorplan-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin-top: 12px;
        }
        .floorplan-img {
            width: 100%;
            display: block;
        }
        #floorplanCells,
        #sectorFloorplanCells {
            position: absolute;
            inset: 0;
        }
        .floorplan-cell {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: #ffffff;
            font-size: 11px;
            text-align: center;
            padding: 2px;
        }
        .floorplan-cell-select {
            cursor: pointer;
            background: rgba(0,122,255,0.10);
        }
        .floorplan-cell-select.selected {
            background: rgba(255,159,10,0.80);
            color: #fff;
            border: 2px solid #ff9500;
        }

        /* ë‚ ì§œ í•„í„° */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }
        .filter-row label {
            font-size: 13px;
        }
        .filter-row input[type="date"] {
            padding: 4px 6px;
            font-size: 13px;
        }
        .csv-btn {
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #ffffff;
            background: #34c759;
        }
        .csv-btn.disabled {
            background: #c0c0c8;
            cursor: default;
        }
        
        /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
        .image-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .image-modal-inner {
            position: relative;
            max-width: 95vw;
            max-height: 90vh;
        }
        .image-modal-inner img {
            max-width: 95vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }
        .image-modal-close {
            position: absolute;
            right: -6px;
            top: -6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.7);
            color: #ffffff;
            cursor: pointer;
            font-size: 16px;
        }

        /* ì¶œì…/ì‹ê¶Œ ë°ëª¨ìš© ì…ë ¥ */
        .text-input {
            width: 100%;
            padding: 8px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid #d0d0d4;
        }
        .small-btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }
        .small-btn-row button {
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            background: #e5e5ea;
        }
        .qr-box {
            margin-top: 8px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .qr-box-inner {
            padding: 8px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .qr-label {
            font-size: 12px;
            color: #444;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 6px;
        }
        .log-table th,
        .log-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #eeeeee;
        }
        .log-table th {
            background: #f0f0f5;
            text-align: left;
            font-weight: 600;
        }

        textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            padding: 6px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid #d0d0d4;
        }

        /* ëª¨ë°”ì¼ */
        @media (max-width: 600px) {
            header { padding: 10px 12px; }
            main   { padding: 10px 12px 32px 12px; }
            h1     { font-size: 16px; }
            .section-title {
                margin-top: 12px;
                font-size: 14px;
            }
            .row { flex-direction: column; }
            .row > div { min-width: 0; }
            .report-card { padding: 10px; }
        }
    </style>
</head>
<body>
<header>
    <h1>ì •ë¦¬ì •ëˆ ì‹ ê³ ì²´ê³„</h1>
    <div class="mode-toggle">
        <div class="mode-btn active" id="mode-report">ì‹ ê³  ë“±ë¡</div>
        <div class="mode-btn" id="mode-heatmap">íˆíŠ¸ë§µ ë³´ê¸° (ê´€ë¦¬ì)</div>
        <div class="mode-btn" id="mode-qr">ì¶œì…Â·ì‹ê¶Œ (QR ë°ëª¨)</div>
    </div>
</header>

<main>
    <!-- ì‹ ê³  ë“±ë¡ í™”ë©´ -->
    <section id="screen-report">
        <div class="section-title">â‘  ì¸µ ì„ íƒ</div>
        <div class="floor-picker">
            <select id="floorSelect"></select>
        </div>

        <div class="section-title">â‘¡ í‰ë©´ë„ ì„¹í„° ì„ íƒ</div>
        <!-- B1ìš© ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
        <div id="sectorGrid" class="sector-grid"></div>
        <!-- 1~6ì¸µìš© í‰ë©´ë„ ì„ íƒ -->
        <div id="sectorFloorplan" class="floorplan-wrapper" style="display:none;">
            <img src="plan_6f.png" alt="ì¸µ í‰ë©´ë„" class="floorplan-img">
            <div id="sectorFloorplanCells"></div>
        </div>

        <div class="section-title">â‘¢ ìœ„í—˜ ìœ í˜• & ê¸°íƒ€ ì‚¬í•­</div>
        <div class="row">
            <div>
                <div style="font-size: 13px;">ìœ„í—˜ ìœ í˜•</div>
                <select id="hazardSelect"></select>
            </div>
        </div>
        <div style="margin-top:6px; font-size:13px;">ê¸°íƒ€ ì‚¬í•­ (ìƒì„¸ ìœ„ì¹˜, ìƒí™© ë“± ììœ  ì…ë ¥)</div>
        <textarea id="hazardDetail" placeholder="ì˜ˆ: í†µë¡œ ì¤‘ì•™ì— ìì¬ ë”ë¯¸, ì•¼ê°„ ì‘ì—…ìœ¼ë¡œ ì¡°ë„ ë¶€ì¡± ë“±"></textarea>

        <div class="section-title">â‘£ ì‚¬ì§„ ì²¨ë¶€ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</div>
        <div class="photo-buttons">
            <button class="btn-album" id="btnAlbum">ì•¨ë²”ì—ì„œ ì„ íƒ</button>
            <button class="btn-camera" id="btnCamera">ì¹´ë©”ë¼ ì´¬ì˜</button>
            <input type="file" id="fileInput" accept="image/*" multiple style="display:none;">
        </div>
        <div id="selectedThumbs" class="thumb-list"></div>

        <button class="primary-btn" id="btnRegister">ìœ„í—˜ ì „ì†¡í•˜ê¸°</button>

        <div class="reports-header">
            <h2>ë“±ë¡ëœ ì‹ ê³  <span id="reportCount">(0ê±´)</span></h2>
        </div>
        <div id="reportList"></div>
    </section>

    <!-- íˆíŠ¸ë§µ + ê´€ë¦¬ì ë¡œê·¸ í™”ë©´ -->
    <section id="screen-heatmap" style="display:none;">
        <div class="section-title">ì¸µ ì„ íƒ</div>
        <div class="floor-picker">
            <select id="heatFloorSelect"></select>
        </div>
        <div style="font-size: 13px; margin-top: 6px;">
            í˜„ì¬ ì¸µ ì„¹í„°ë³„ ì‹ ê³  íˆíŠ¸ë§µ<br>
            <span style="font-size: 11px; color:#666;">â€» ìƒ‰ì´ ì§„í• ìˆ˜ë¡ ì‹ ê³  íšŸìˆ˜ê°€ ë§ì€ êµ¬ì—­ì…ë‹ˆë‹¤.</span>
        </div>

        <!-- í‰ë©´ë„ íˆíŠ¸ë§µ (1~6ì¸µ) -->
        <div id="heatmapFloorplan" class="floorplan-wrapper" style="display:none;">
            <img src="plan_6f.png" alt="ì¸µ í‰ë©´ë„" class="floorplan-img">
            <div id="floorplanCells"></div>
        </div>

        <!-- B1 íˆíŠ¸ë§µìš© ê¸°ë³¸ ê·¸ë¦¬ë“œ -->
        <div id="heatmapGrid" class="heatmap-grid"></div>

        <!-- CSV ë‚´ë³´ë‚´ê¸° (ë‚ ì§œ í•„í„°) -->
        <div class="section-title" style="margin-top:20px;">ì‹ ê³  ë‚´ì—­ CSV ë‚´ë³´ë‚´ê¸°</div>
        <div class="filter-row">
            <label for="startDate">ì‹œì‘ì¼</label>
            <input type="date" id="startDate">
            <label for="endDate">ì¢…ë£Œì¼</label>
            <input type="date" id="endDate">
            <button id="btnCSVExport" class="csv-btn">
                <span>ğŸ“¤</span><span>CSVë¡œ ë‚´ë³´ë‚´ê¸°</span>
            </button>
        </div>
        <div style="font-size:11px; color:#666; margin-top:4px;">
            * ë‚ ì§œë¥¼ ë¹„ì›Œë‘ë©´ ì „ì²´ ê¸°ê°„ ë°ì´í„°ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
        </div>

        <!-- ê´€ë¦¬ììš© ì¶œì…/ì‹ê¶Œ ë¡œê·¸ -->
        <div class="section-title" style="margin-top:24px;">ì¶œì… ë¡œê·¸ (ë°ëª¨)</div>
        <table class="log-table">
            <thead>
            <tr>
                <th>ì‹œê°„</th>
                <th>ì‘ì—…ì</th>
                <th>êµ¬ë¶„</th>
            </tr>
            </thead>
            <tbody id="entryLogBody"></tbody>
        </table>

        <div class="section-title" style="margin-top:18px;">ì‹ê¶Œ ë°œê¸‰ ë¡œê·¸ (ë°ëª¨)</div>
        <table class="log-table">
            <thead>
            <tr>
                <th>ì‹œê°„</th>
                <th>ì‘ì—…ì</th>
                <th>í† í°</th>
            </tr>
            </thead>
            <tbody id="mealLogBody"></tbody>
        </table>
    </section>

    <!-- ì¶œì…Â·ì‹ê¶Œ QR ë°ëª¨ í™”ë©´ -->
    <section id="screen-qr" style="display:none;">
        <div class="section-title">ì‘ì—…ì ì •ë³´</div>
        <div>
            <div style="font-size:13px; margin-bottom:4px;">ì‘ì—…ì ì´ë¦„ ë˜ëŠ” ID</div>
            <input id="workerIdInput" class="text-input" placeholder="ì˜ˆ: í™ê¸¸ë™, W001 ë“±">
        </div>

        <div class="section-title" style="margin-top:14px;">ì¶œì…ìš© QR</div>
        <div class="small-btn-row">
            <button id="btnPassQR">ì¶œì…ìš© QR ìƒì„±</button>
            <button id="btnMockEntryIn">ì…ì¥ ë¡œê·¸ ì¶”ê°€(ë°ëª¨)</button>
            <button id="btnMockEntryOut">í‡´ì¥ ë¡œê·¸ ì¶”ê°€(ë°ëª¨)</button>
        </div>
        <div class="qr-box">
            <div>
                <div class="qr-label">ì¶œì…ìš© QR (ë°ëª¨)</div>
                <div id="passQrBox" class="qr-box-inner"></div>
            </div>
        </div>

        <div class="section-title" style="margin-top:18px;">ì‹ê¶Œ QR</div>
        <div class="small-btn-row">
            <button id="btnMealQR">ì˜¤ëŠ˜ ì‹ê¶Œ QR ë°œê¸‰(ë°ëª¨)</button>
        </div>
        <div class="qr-box">
            <div>
                <div class="qr-label">ì‹ê¶Œ QR (ë°ëª¨)</div>
                <div id="mealQrBox" class="qr-box-inner"></div>
            </div>
            <div class="qr-label" id="mealStatus" style="min-width: 160px;">
                ì•„ì§ ì˜¤ëŠ˜ ì‹ê¶Œì´ ë°œê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div style="margin-top:16px; font-size:11px; color:#666;">
            * ì‹¤ì œ í˜„ì¥ ì ìš© ì‹œ ì´ QR ë°ì´í„°ëŠ” ì¶œì…ê´€ë¦¬ ì‹œìŠ¤í…œ / ì‹ë‹¹ ì‹œìŠ¤í…œê³¼ ì—°ë™í•´ì„œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </section>
</main>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="imageModal" class="image-modal-backdrop" style="display:none;">
    <div class="image-modal-inner">
        <button class="image-modal-close" id="imageModalClose">âœ•</button>
        <img id="imageModalImg" src="">
    </div>
</div>

<!-- QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    /* === ìœ í‹¸ === */
    function makeSectors(prefix) {
        const arr = [];
        for (let i = 1; i <= 34; i++) arr.push(`${prefix}-${i}`);
        return arr;
    }

    /* === ì¸µ / ì„¹í„° ì •ì˜ === */
    const floors = [
        { id: "1F", name: "1ì¸µ",      sectors: makeSectors("A") },
        { id: "2F", name: "2ì¸µ",      sectors: makeSectors("B") },
        { id: "3F", name: "3ì¸µ",      sectors: makeSectors("C") },
        { id: "4F", name: "4ì¸µ",      sectors: makeSectors("D") },
        { id: "5F", name: "5ì¸µ",      sectors: makeSectors("E") },
        { id: "6F", name: "6ì¸µ",      sectors: makeSectors("G") }
    ];

    const hazardTypes = [
        { id: "ë‹¨ì°¨",       label: "ë‹¨ì°¨" },
        { id: "ë¯¸ë„ëŸ¬ì§",   label: "ë¯¸ë„ëŸ¬ì§(ë¬¼Â·ê¸°ë¦„Â·ë¨¼ì§€ ë“±)" },
        { id: "ì •ë¦¬ë¶ˆëŸ‰",   label: "ì •ë¦¬ ë¶ˆëŸ‰(ìì¬/íê¸°ë¬¼ ë°©ì¹˜)" },
        { id: "í†µë¡œë§‰í˜",   label: "í†µë¡œ ë§‰í˜(ìì¬ ì ì¹˜Â·ì¥ë¹„ ë“±)" },
        { id: "ì¶”ë½ë‚™í•˜",   label: "ì¶”ë½Â·ë‚™í•˜ ìœ„í—˜(ê°œêµ¬ë¶€, ë‚œê°„ ë¯¸ì„¤ì¹˜ ë“±)" },
        { id: "ì¡°ë„ë¶ˆëŸ‰",   label: "ì¡°ë„ ë¶€ì¡±/ì‹œì•¼ ë¶ˆëŸ‰" },
        { id: "ì „ë„ë„˜ì–´ì§", label: "ì „ë„Â·ë„˜ì–´ì§ ìœ„í—˜(ì¼€ì´ë¸”, í˜¸ìŠ¤ ë“±)" },
        { id: "ê¸°íƒ€",       label: "ê¸°íƒ€" }
    ];

    /* === í‰ë©´ë„ ë ˆì´ì•„ì›ƒ(34ê°œ) : 1~6ì¸µ ê³µí†µ === */
    const sectorLayout = {
        1:  { x: 0.019,  y: 0.383, w: 0.050,  h: 0.243 },
        2:  { x: 0.072,  y: 0.383, w: 0.087,  h: 0.243 },
        3:  { x: 0.1639, y: 0.383, w: 0.103,  h: 0.243 },
        4:  { x: 0.270,  y: 0.383, w: 0.072,  h: 0.243 },
        5:  { x: 0.346,  y: 0.383, w: 0.045,  h: 0.243 },
        6:  { x: 0.019,  y: 0.633, w: 0.151,  h: 0.0755 },
        7:  { x: 0.170,  y: 0.633, w: 0.113,  h: 0.0755 },
        8:  { x: 0.283,  y: 0.633, w: 0.113,  h: 0.0755 },
        9:  { x: 0.019,  y: 0.715, w: 0.050,  h: 0.243 },
        10: { x: 0.072,  y: 0.715, w: 0.046,  h: 0.243 },
        11: { x: 0.123,  y: 0.715, w: 0.046,  h: 0.243 },
        12: { x: 0.173,  y: 0.715, w: 0.052,  h: 0.243 },
        13: { x: 0.2275, y: 0.715, w: 0.0525, h: 0.243 },
        14: { x: 0.284,  y: 0.715, w: 0.052,  h: 0.243 },
        15: { x: 0.3403, y: 0.715, w: 0.055,  h: 0.243 },
        16: { x: 0.397,  y: 0.383, w: 0.105,  h: 0.400 },
        17: { x: 0.505,  y: 0.383, w: 0.047,  h: 0.243 },
        18: { x: 0.554,  y: 0.383, w: 0.065,  h: 0.243 },
        19: { x: 0.622,  y: 0.383, w: 0.101,  h: 0.243 },
        20: { x: 0.728,  y: 0.383, w: 0.066,  h: 0.243 },
        21: { x: 0.795,  y: 0.383, w: 0.045,  h: 0.243 },
        22: { x: 0.503,  y: 0.633, w: 0.155,  h: 0.0755 },
        23: { x: 0.659,  y: 0.633, w: 0.185,  h: 0.0755 },
        24: { x: 0.505,  y: 0.715, w: 0.068,  h: 0.243 },
        25: { x: 0.577,  y: 0.715, w: 0.080,  h: 0.243 },
        26: { x: 0.661,  y: 0.715, w: 0.065,  h: 0.243 },
        27: { x: 0.730,  y: 0.715, w: 0.108,  h: 0.243 },
        28: { x: 0.842,  y: 0.715, w: 0.150,  h: 0.243 },
        29: { x: 0.845,  y: 0.383, w: 0.036,  h: 0.330 },
        30: { x: 0.885,  y: 0.485, w: 0.107,  h: 0.226 },
        31: { x: 0.885,  y: 0.254, w: 0.107,  h: 0.226 },
        32: { x: 0.885,  y: 0.020, w: 0.107,  h: 0.2275 },
        33: { x: 0.845,  y: 0.020, w: 0.036,  h: 0.363 },
        34: { x: 0.727,  y: 0.020, w: 0.115,  h: 0.357 }
    };

    let reports = [];
    let selectedFloorIndex = 0;
    let selectedSectorId = null;
    let selectedHazard = hazardTypes[0].id;
    let selectedImages = [];

    let entryLogs = [];
    let mealLogs  = [];
    let passQrInstance = null;
    let mealQrInstance = null;

    const modeReportBtn   = document.getElementById("mode-report");
    const modeHeatmapBtn  = document.getElementById("mode-heatmap");
    const modeQrBtn       = document.getElementById("mode-qr");
    const screenReport    = document.getElementById("screen-report");
    const screenHeatmap   = document.getElementById("screen-heatmap");
    const screenQr        = document.getElementById("screen-qr");

    const floorSelect     = document.getElementById("floorSelect");
    const sectorGrid      = document.getElementById("sectorGrid");
    const sectorFloorplan = document.getElementById("sectorFloorplan");
    const sectorFloorplanCells = document.getElementById("sectorFloorplanCells");
    const hazardSelect    = document.getElementById("hazardSelect");
    const hazardDetailEl  = document.getElementById("hazardDetail");

    const selectedThumbs  = document.getElementById("selectedThumbs");
    const fileInput       = document.getElementById("fileInput");
    const btnAlbum        = document.getElementById("btnAlbum");
    const btnCamera       = document.getElementById("btnCamera");
    const btnRegister     = document.getElementById("btnRegister");

    const reportList      = document.getElementById("reportList");
    const reportCount     = document.getElementById("reportCount");

    const heatFloorSelect = document.getElementById("heatFloorSelect");
    const heatmapGrid     = document.getElementById("heatmapGrid");
    const heatmapFloorplan = document.getElementById("heatmapFloorplan");
    const floorplanCells   = document.getElementById("floorplanCells");

    const startDateInput  = document.getElementById("startDate");
    const endDateInput    = document.getElementById("endDate");
    const btnCSVExport    = document.getElementById("btnCSVExport");

    const imageModal      = document.getElementById("imageModal");
    const imageModalImg   = document.getElementById("imageModalImg");
    const imageModalClose = document.getElementById("imageModalClose");

    const workerIdInput   = document.getElementById("workerIdInput");
    const btnPassQR       = document.getElementById("btnPassQR");
    const btnMockEntryIn  = document.getElementById("btnMockEntryIn");
    const btnMockEntryOut = document.getElementById("btnMockEntryOut");
    const passQrBox       = document.getElementById("passQrBox");

    const btnMealQR       = document.getElementById("btnMealQR");
    const mealQrBox       = document.getElementById("mealQrBox");
    const mealStatus      = document.getElementById("mealStatus");

    const entryLogBody    = document.getElementById("entryLogBody");
    const mealLogBody     = document.getElementById("mealLogBody");

    /* === ëª¨ë“œ ì „í™˜ === */
    function setMode(mode) {
        [modeReportBtn, modeHeatmapBtn, modeQrBtn].forEach(btn => btn.classList.remove("active"));
        if (mode === "report")  modeReportBtn.classList.add("active");
        if (mode === "heatmap") modeHeatmapBtn.classList.add("active");
        if (mode === "qr")      modeQrBtn.classList.add("active");

        screenReport.style.display  = (mode === "report")  ? "" : "none";
        screenHeatmap.style.display = (mode === "heatmap") ? "" : "none";
        screenQr.style.display      = (mode === "qr")      ? "" : "none";

        if (mode === "heatmap") {
            updateHeatmap();
            renderAdminLogs();
        }
    }
    modeReportBtn.addEventListener("click", () => setMode("report"));
    modeHeatmapBtn.addEventListener("click", () => setMode("heatmap"));
    modeQrBtn.addEventListener("click", () => setMode("qr"));

    /* === ì´ˆê¸°í™” === */
    function initFloorSelects() {
        floors.forEach((f, index) => {
            const o1 = document.createElement("option");
            o1.value = index;
            o1.textContent = f.name;
            floorSelect.appendChild(o1);

            const o2 = document.createElement("option");
            o2.value = index;
            o2.textContent = f.name;
            heatFloorSelect.appendChild(o2);
        });

        floorSelect.value     = "0";
        heatFloorSelect.value = "0";
        renderSectorSelection();
    }

    function initHazardSelect() {
        hazardTypes.forEach(h => {
            const opt = document.createElement("option");
            opt.value = h.id;
            opt.textContent = h.label;
            hazardSelect.appendChild(opt);
        });
        hazardSelect.value = hazardTypes[0].id;
    }

    floorSelect.addEventListener("change", () => {
        selectedFloorIndex = parseInt(floorSelect.value, 10);
        selectedSectorId = null;
        renderSectorSelection();
        updateRegisterButtonState();
    });
    heatFloorSelect.addEventListener("change", () => {
        selectedFloorIndex = parseInt(heatFloorSelect.value, 10);
        updateHeatmap();
    });

    hazardSelect.addEventListener("change", () => {
        selectedHazard = hazardSelect.value;
    });

    /* === ì‹ ê³  í™”ë©´: ì„¹í„° ì„ íƒ ë Œë”ë§ === */
    function renderSectorSelection() {
        const floor = floors[selectedFloorIndex];

        if (floor.id === "B1") {
            // B1 : ë²„íŠ¼ ê·¸ë¦¬ë“œ
            sectorGrid.style.display = "grid";
            sectorFloorplan.style.display = "none";
            sectorGrid.innerHTML = "";

            floor.sectors.forEach(sectorId => {
                const btn = document.createElement("div");
                btn.className = "sector-btn" + (selectedSectorId === sectorId ? " selected" : "");
                btn.textContent = sectorId + " êµ¬ì—­";
                btn.addEventListener("click", () => {
                    selectedSectorId = sectorId;
                    renderSectorSelection();
                    updateRegisterButtonState();
                });
                sectorGrid.appendChild(btn);
            });
        } else {
            // 1~6ì¸µ : í‰ë©´ë„ì—ì„œ ì„ íƒ
            sectorGrid.style.display = "none";
            sectorFloorplan.style.display = "block";
            sectorFloorplanCells.innerHTML = "";

            const sectors = floor.sectors;
            const totalCells = sectors.length;

            for (let i = 1; i <= totalCells; i++) {
                const layout = sectorLayout[i];
                if (!layout) continue;

                const sectorId = sectors[i - 1];
                const cell = document.createElement("div");
                cell.className = "floorplan-cell floorplan-cell-select" +
                                 (selectedSectorId === sectorId ? " selected" : "");
                cell.style.left   = (layout.x * 100) + "%";
                cell.style.top    = (layout.y * 100) + "%";
                cell.style.width  = (layout.w * 100) + "%";
                cell.style.height = (layout.h * 100) + "%";
                cell.innerHTML = `<div>${sectorId}</div>`;

                cell.addEventListener("click", () => {
                    selectedSectorId = sectorId;
                    renderSectorSelection();
                    updateRegisterButtonState();
                });

                sectorFloorplanCells.appendChild(cell);
            }
        }
    }

    /* === ì‚¬ì§„ ì²¨ë¶€ === */
    btnAlbum.addEventListener("click", () => {
        fileInput.removeAttribute("capture");
        fileInput.click();
    });
    btnCamera.addEventListener("click", () => {
        fileInput.setAttribute("capture", "environment");
        fileInput.click();
    });
    fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files || []);
        files.forEach(file => {
            if (!file.type.startsWith("image/")) return;
            const url = URL.createObjectURL(file);
            selectedImages.push({ file, url });
        });
        renderSelectedThumbs();
        fileInput.value = "";
    });

    function renderSelectedThumbs() {
        selectedThumbs.innerHTML = "";
        selectedImages.forEach(imgObj => {
            const img = document.createElement("img");
            img.src = imgObj.url;
            selectedThumbs.appendChild(img);
        });
    }

    /* === ì‹ ê³  ë“±ë¡ === */
    btnRegister.addEventListener("click", () => {
        if (!selectedSectorId) return;

        const floor = floors[selectedFloorIndex];
        const floorId = floor.id;
        const floorName = floor.name;
        const sectorId = selectedSectorId;
        const sectorName = sectorId + " êµ¬ì—­";
        const locationCode = `${floorId}-${sectorId}`;
        const hazardType = selectedHazard;
        const hazardDetail = hazardDetailEl.value.trim();
        const date = new Date();

        const images = selectedImages.map(imgObj => ({ url: imgObj.url }));

        const report = {
            id: crypto.randomUUID(),
            floorId,
            floorName,
            sectorId,
            sectorName,
            locationCode,
            hazardType,
            hazardDetail,
            date,
            images
        };

        reports.unshift(report);

        selectedSectorId = null;
        selectedImages = [];
        hazardDetailEl.value = "";
        renderSelectedThumbs();
        renderSectorSelection();
        renderReportList();
        updateRegisterButtonState();
        updateHeatmap();
    });

    function deleteReport(id) {
        reports = reports.filter(r => r.id !== id);
        renderReportList();
        updateHeatmap();
    }

    function renderReportList() {
        reportList.innerHTML = "";
        reportCount.textContent = `(${reports.length}ê±´)`;

        reports.forEach(report => {
            const card = document.createElement("div");
            card.className = "report-card";

            const title = document.createElement("div");
            title.className = "report-title";
            title.textContent = `${report.floorName} Â· ${report.sectorName}`;

            const meta1 = document.createElement("div");
            meta1.className = "report-meta";
            meta1.textContent = `ìœ„ì¹˜ì½”ë“œ: ${report.locationCode}`;

            const meta2 = document.createElement("div");
            meta2.className = "report-meta";
            meta2.textContent = `ìœ„í—˜ìœ í˜•: ${report.hazardType}`;

            const meta3 = document.createElement("div");
            meta3.className = "report-meta";
            meta3.textContent = formatDate(report.date);

            card.appendChild(title);
            card.appendChild(meta1);
            card.appendChild(meta2);

            if (report.hazardDetail) {
                const metaDetail = document.createElement("div");
                metaDetail.className = "report-meta";
                metaDetail.textContent = `ê¸°íƒ€ì‚¬í•­: ${report.hazardDetail}`;
                card.appendChild(metaDetail);
            }

            card.appendChild(meta3);

            const del = document.createElement("button");
            del.className = "report-delete";
            del.textContent = "ğŸ—‘";
            del.addEventListener("click", () => deleteReport(report.id));
            card.appendChild(del);

            if (report.images && report.images.length > 0) {
                const photoRow = document.createElement("div");
                photoRow.className = "report-photos";
                report.images.forEach(imgObj => {
                    const img = document.createElement("img");
                    img.src = imgObj.url;
                    img.addEventListener("click", () => openImageModal(imgObj.url));
                    photoRow.appendChild(img);
                });
                card.appendChild(photoRow);
            }

            reportList.appendChild(card);
        });
    }

    function updateRegisterButtonState() {
        btnRegister.disabled = !selectedSectorId;
    }

    /* === ì´ë¯¸ì§€ ëª¨ë‹¬ === */
    function openImageModal(url) {
        imageModalImg.src = url;
        imageModal.style.display = "flex";
    }
    imageModalClose.addEventListener("click", () => {
        imageModal.style.display = "none";
        imageModalImg.src = "";
    });
    imageModal.addEventListener("click", (e) => {
        if (e.target === imageModal) {
            imageModal.style.display = "none";
            imageModalImg.src = "";
        }
    });

    /* === CSV ë‚´ë³´ë‚´ê¸° === */
    btnCSVExport.addEventListener("click", () => {
        if (reports.length === 0) {
            alert("ë‚´ë³´ë‚¼ ì‹ ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        let startDate = startDateInput.value ? new Date(startDateInput.value + "T00:00:00") : null;
        let endDate   = endDateInput.value   ? new Date(endDateInput.value   + "T23:59:59") : null;

        const filtered = reports.filter(r => {
            if (!startDate && !endDate) return true;
            if (startDate && r.date < startDate) return false;
            if (endDate && r.date > endDate) return false;
            return true;
        });

        if (filtered.length === 0) {
            alert("ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        let csv = "floorId,floorName,sectorId,sectorName,locationCode,hazardType,hazardDetail,date,imageCount\n";
        filtered.forEach(r => {
            const dateStr = formatCSVDate(r.date);
            const line = [
                r.floorId,
                quote(r.floorName),
                r.sectorId,
                quote(r.sectorName),
                r.locationCode,
                quote(r.hazardType),
                quote(r.hazardDetail || ""),
                dateStr,
                r.images ? r.images.length : 0
            ].join(",");
            csv += line + "\n";
        });

        const bom  = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });

        const url = URL.createObjectURL(blob);
        const a   = document.createElement("a");
        const ts  = new Date();
        const name = `Reports_${formatFilenameDate(ts)}.csv`;
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    function quote(str) {
        return `"${String(str).replace(/"/g, '""')}"`;
    }

    function formatDate(d) {
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).toString().padStart(2, "0");
        const mi = String(d.getMinutes()).toString().padStart(2, "0");
        return `${yy}.${mm}.${dd} ${hh}:${mi}`;
    }
    function formatCSVDate(d) {
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).toString().padStart(2, "0");
        const mi = String(d.getMinutes()).toString().padStart(2, "0");
        const ss = String(d.getSeconds()).toString().padStart(2, "0");
        return `${yy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }
    function formatFilenameDate(d) {
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).toString().padStart(2, "0");
        const mi = String(d.getMinutes()).toString().padStart(2, "0");
        const ss = String(d.getSeconds()).toString().padStart(2, "0");
        return `${yy}${mm}${dd}_${hh}${mi}${ss}`;
    }

    /* === íˆíŠ¸ë§µ ìƒ‰ === */
    function heatColor(count) {
        if (count === 0) return "rgba(52,199,89,0.5)";
        if (count <= 2)  return "rgba(255,204,0,0.8)";
        if (count <= 4)  return "rgba(255,149,0,0.85)";
        return "rgba(255,59,48,0.9)";
    }

    /* === íˆíŠ¸ë§µ ê°±ì‹  === */
    function updateHeatmap() {
        const floor = floors[selectedFloorIndex];
        const floorId = floor.id;

        if (floor.id === "B1") {
            // B1 : ê¸°ì¡´ ê·¸ë¦¬ë“œ íˆíŠ¸ë§µ
            heatmapFloorplan.style.display = "none";
            heatmapGrid.style.display = "grid";
            heatmapGrid.innerHTML = "";

            floor.sectors.forEach(sectorId => {
                const count = reports.filter(r => r.floorId === floorId && r.sectorId === sectorId).length;
                const cell = document.createElement("div");
                cell.className = "heat-cell";
                cell.style.background = heatColor(count);
                cell.innerHTML = `<div>${sectorId} êµ¬ì—­</div><div>${count}ê±´</div>`;
                heatmapGrid.appendChild(cell);
            });
        } else {
            // 1~6ì¸µ : í‰ë©´ë„ ìœ„ íˆíŠ¸ë§µ
            heatmapGrid.style.display = "none";
            heatmapFloorplan.style.display = "block";
            floorplanCells.innerHTML = "";

            const sectors = floor.sectors;
            const totalCells = sectors.length;

            for (let i = 1; i <= totalCells; i++) {
                const layout = sectorLayout[i];
                if (!layout) continue;

                const sectorId = sectors[i - 1];
                const count = reports.filter(r => r.floorId === floorId && r.sectorId === sectorId).length;

                const cell = document.createElement("div");
                cell.className = "floorplan-cell";
                cell.style.left   = (layout.x * 100) + "%";
                cell.style.top    = (layout.y * 100) + "%";
                cell.style.width  = (layout.w * 100) + "%";
                cell.style.height = (layout.h * 100) + "%";
                cell.style.background = heatColor(count);
                cell.innerHTML = `<div>${sectorId}</div><div>${count}ê±´</div>`;
                floorplanCells.appendChild(cell);
            }
        }
    }

    /* === ì¶œì…/ì‹ê¶Œ ë°ëª¨ === */
    btnPassQR.addEventListener("click", () => {
        const workerId = workerIdInput.value.trim();
        if (!workerId) {
            alert("ì‘ì—…ì ì´ë¦„ ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!passQrInstance) {
            passQrBox.innerHTML = "";
            passQrInstance = new QRCode(passQrBox, {
                text: "",
                width: 160,
                height: 160
            });
        }
        passQrInstance.makeCode(`PASS:${workerId}`);
    });

    function addEntryLog(type) {
        const workerId = workerIdInput.value.trim();
        if (!workerId) {
            alert("ì‘ì—…ì ì´ë¦„ ë˜ëŠ” IDë¥¼ ì…ë ¥í•œ í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
            return;
        }
        const now = new Date();
        const log = { id: crypto.randomUUID(), workerId, time: now, type };
        entryLogs.unshift(log);
        renderAdminLogs();
    }
    btnMockEntryIn.addEventListener("click", () => addEntryLog("ì…ì¥"));
    btnMockEntryOut.addEventListener("click", () => addEntryLog("í‡´ì¥"));

    btnMealQR.addEventListener("click", () => {
        const workerId = workerIdInput.value.trim();
        if (!workerId) {
            alert("ì‘ì—…ì ì´ë¦„ ë˜ëŠ” IDë¥¼ ì…ë ¥í•œ í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!mealQrInstance) {
            mealQrBox.innerHTML = "";
            mealQrInstance = new QRCode(mealQrBox, {
                text: "",
                width: 160,
                height: 160
            });
        }
        const now = new Date();
        const token = `MEAL-${formatFilenameDate(now)}-${Math.floor(1000 + Math.random() * 9000)}`;
        mealQrInstance.makeCode(token);

        mealStatus.textContent = `ì˜¤ëŠ˜ ì‹ê¶Œ ë°œê¸‰ë¨ (ID: ${workerId})`;

        const log = { id: crypto.randomUUID(), workerId, time: now, token };
        mealLogs.unshift(log);
        renderAdminLogs();
    });

    function renderAdminLogs() {
        // ì¶œì… ë¡œê·¸
        entryLogBody.innerHTML = "";
        if (entryLogs.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.textContent = "ì¶œì… ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
            td.style.textAlign = "center";
            td.style.color = "#666";
            tr.appendChild(td);
            entryLogBody.appendChild(tr);
        } else {
            entryLogs.forEach(log => {
                const tr = document.createElement("tr");
                const tdTime = document.createElement("td");
                const tdWorker = document.createElement("td");
                const tdType = document.createElement("td");
                tdTime.textContent = formatDate(log.time);
                tdWorker.textContent = log.workerId;
                tdType.textContent = log.type;
                tr.appendChild(tdTime);
                tr.appendChild(tdWorker);
                tr.appendChild(tdType);
                entryLogBody.appendChild(tr);
            });
        }

        // ì‹ê¶Œ ë¡œê·¸
        mealLogBody.innerHTML = "";
        if (mealLogs.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.textContent = "ì‹ê¶Œ ë°œê¸‰ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
            td.style.textAlign = "center";
            td.style.color = "#666";
            tr.appendChild(td);
            mealLogBody.appendChild(tr);
        } else {
            mealLogs.forEach(log => {
                const tr = document.createElement("tr");
                const tdTime = document.createElement("td");
                const tdWorker = document.createElement("td");
                const tdToken = document.createElement("td");
                tdTime.textContent = formatDate(log.time);
                tdWorker.textContent = log.workerId;
                tdToken.textContent = log.token;
                tr.appendChild(tdTime);
                tr.appendChild(tdWorker);
                tr.appendChild(tdToken);
                mealLogBody.appendChild(tr);
            });
        }
    }

    /* === ì´ˆê¸° ì‹¤í–‰ === */
    initFloorSelects();
    initHazardSelect();
    renderReportList();
    renderAdminLogs();
    updateRegisterButtonState();
    updateHeatmap();
</script>
</body>
</html>






